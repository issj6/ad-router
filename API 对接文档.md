## 1. 接口概述

本文档旨在为合作伙伴提供广告点击数据上报及转化事件回调的详细技术规范。通过调用点击上报接口，媒体可将用户广告点击行为数据实时同步至我方系统，以便进行后续的效果追踪与归因分析。

### 交互流程简介

1. **用户点击广告**: 用户在媒体应用内点击广告素材。
    
2. **媒体方上报点击**: 媒体服务器通过 GET 请求，调用我方提供的点击上报接口，并传递必要的设备及广告参数。
    
3. **系统记录并归因**: 我方系统接收数据，进行有效性验证，并根据归因逻辑匹配后续的转化行为。
    
4. **转化数据回调**: 当用户产生激活、注册、付费等转化行为时，我方系统将通过媒体方提供的回调链接，将转化事件信息实时回传。
    

## 2. 点击数据上报

### 2.1. 请求地址

```
http://ckapi.notnull.cc:6789/click
```

### 2.2. 请求方式

**GET**

### 2.3. 请求参数

|              |                  |                                         |         |          |
| ------------ | ---------------- | --------------------------------------- | ------- | -------- |
| **参数名**      | **宏替换**          | **描述**                                  | **类型**  | **是否必填** |
| `aid`        | `_AID_`          | **广告活动ID**，由我方运营或系统提供，用于标识唯一的广告活动。      | String  | **是**    |
| `did`        | `_DID_`          | **渠道来源ID**，我方提供                         | String  | **是**    |
| `os`         | `_OS_`           | **操作系统类型**。ANDROID、IOS取其一               | Integer | **是**    |
| `ts`         | `_TS_`           | **点击发生时间戳**，服务器时间的13位毫秒级 UTC 时间戳。       | Long    | **是**    |
| `callback`   | `_CALLBACK_`     | **转化回调地址**，用于接收转化事件通知。请务必进行 URL Encode。 | String  | **是**    |
| `oaid`       | `**OAID**`       | **Android Q+ 匿名设备标识符**。安卓设备应优先传递此参数。    | String  | 安卓必填     |
| `imei`       | `**IMEI**`       | **国际移动设备识别码**。获取不到 OAID 时的备选方案。         | String  | 安卓必填     |
| `android_id` | `**ANDROID_ID**` | **安卓ID原始值**。获取不到 OAID 和 IMEI 时的备选方案。    | String  | 安卓必填     |
| `idfa`       | `**IDFA**`       | **iOS 广告标识符**。iOS 14.5+ 可能为空。           | String  | iOS 必填   |
| `caid`       | `**CAID**`       | **中国广告协会 CAID 标识**。获取不到 IDFA 时的备选方案。    | String  | iOS 必填   |
| `ip`         | `_IP_`           | 用户设备的公网 IPv4 地址，用于辅助归因。                 | String  | 否        |
| `ua`         | `_UA_`           | 用户设备的 User Agent 字符串，请进行 URL Encode。    | String  | 否        |
| `model`      | `_MODEL_`        | 用户设备的型号，例如 `iPhone13,2` 或 `SM-G9980`。   | String  | 否        |
| `x`          | `_X_`            | **自定义标识符**，我方提供                         | String  | 否        |

**注意**:

- 对于 **Android** 设备，`oaid`, `imei`, `android_id` 三者中至少需要提供一个有效值。
    
- 对于 **iOS** 设备，`idfa` 和 `caid` 两者中至少需要提供一个有效值。
    

### 2.4. 请求示例

```
http://ckapi.notnull.cc:6789/click?aid=12345&did=abc&os=IOS&ts=1666888888000&callback=https%3A%2F%2Fmedia.com%2Fcallback%3Ftrackid%3Dxyz&oaid=your_oaid_here&ip=192.168.1.1&ua=Mozilla%2F5.0...
```

### 2.5. 响应格式

接口将以 JSON 格式返回处理结果。

**上报成功响应**:

- **HTTP 状态码**: `200`
    
- **响应 Body**:
    

```
{
  "success": true,
  "status": 200,
  "message": "success"
}
```

**失败响应**:

- **HTTP 状态码**: `40x`或 `50x`
    
- **响应 Body**:
    

```
{
  "success": false,
  "status": 400,
  "message": "参数错误"
}
```


| HTTP状态码 | 错误原因    |
| ------- | ------- |
| 404     | 资源未找到   |
| 400     | 参数错误    |
| 500     | 服务器内部错误 |
| 501     | 链接已关闭   |

## 3. 设备归因逻辑

为了最大化归因准确率，建议合作方按以下优先级顺序上报设备标识符。我方系统将严格按照此顺序进行匹配归因。

|   |   |   |   |
|---|---|---|---|
|**平台**|**优先级**|**参数**|**说明**|
|**Android**|1 (高)|`oaid`|推荐首选，适用于 Android Q 及以上版本。|
||2 (中)|`imei`|传统设备标识，部分高版本安卓系统可能受限。|
||3 (低)|`ip` + `ua`|当无法获取设备号时，作为辅助归因手段。|
|**iOS**|1 (高)|`idfa`|iOS 平台标准广告标识符。|
||2 (中)|`caid`|当用户关闭 IDFA 追踪时的有效补充。|
||3 (低)|`ip` + `ua`|作为辅助归因手段。|

## 4. 转化数据回调

当归因成功后，若用户完成了关键转化行为，我方系统将通过您在点击上报时传入的 `callback` 地址发送通知。

### 4.1. 回调机制

- **请求方式**: GET
    
- **幂等性**: 请合作方根据回调参数中的唯一标识做好接收端的幂等性处理，避免重复记录。

### 4.2. 回调参数

我们支持在 `callback` 链接中使用宏参数，以便您动态接收转化信息。

|            |                     |            |
| ---------- | ------------------- | ---------- |
| **宏参数**    | **描述**              | **示例值**    |
| `_EVENT_`  | **事件类型**，标识具体的转化行为。 | `activate` |
| `_AMOUNT_` | **付费金额**，仅在付费事件中提供。 | `6.00`     |
| `_DAYS_`   | **留存天数**，仅在留存事件中提供。 | `2`        |
|            |                     |            |

### 4.3. 回调 URL 示例

您配置的原始 Callback URL (已 URL Encode):

https%3a%2f%2fmedia.com%2fcallback%3fxxid%3dxyz%26event%3d_EVENT_%26xxx%3dxxx

我方发起回调时的实际请求 URL:

https://media.com/callback?xxid=xyz&event=ACTIVATED&xxx=xxx(其他参数)

### 4.4. 转化事件类型

| **事件类型 (_EVENT_TYPE_)** | **描述** |
| ----------------------- | ------ |
| `ACTIVATED`             | **激活** |
| `REGISTERED`            | **注册** |
| `PAID`                  | **付费** |
| `RETAINED`              | **留存** |
